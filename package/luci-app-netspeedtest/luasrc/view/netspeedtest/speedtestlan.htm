<%#
 Copyright 2020-2025 sirpdboy Wich <sirpdboy@qq.com>
 https://github.com/sirpdboy/netspeedtest
 Licensed to the public under the Apache License 2.0.
-%>
<%
	local running = luci.sys.exec("busybox ps -w | grep homebox | grep -v grep  >/dev/null && echo -ne '1' ")
%>
<%+cbi/valueheader%>

<div class="cbi-map">
<% if running == "1" then %>
	<style>
		.nst-frame {
			display: block;
			width: 100%;
			border: none;
			border-radius: 6px;
			/* 基线高度，防止脚本失效时过小 */
			min-height: 360px;
			height: calc(100vh - 220px);
		}
	</style>
	<iframe id="homebox" class="nst-frame"></iframe>

	<script type="text/javascript">
	(function() {
		function setSrc() {
			var f = document.getElementById('homebox');
			if (!f) return;
			if (!f.getAttribute('src')) {
				f.src = window.location.protocol + '//' + window.location.hostname + ':3300';
			}
		}

		function resizeFrame() {
			var f = document.getElementById('homebox');
			if (!f) return;
			var rect = f.getBoundingClientRect();
			var available = window.innerHeight - rect.top - 24; // 留出底部余量
			if (available < 360) available = 360;
			f.style.height = available + 'px';
		}

		window.addEventListener('load', function() { setSrc(); resizeFrame(); });
		window.addEventListener('resize', resizeFrame);
	})();
	</script>
<% else %>
	<style>
		.running { text-align: center; padding: 2rem 1rem; }
		.running > h1 { font-size: 1.6rem; color: #333; margin: 1rem; }
		.running > p { font-size: 1.05rem; color: #8391a2; margin: 0.8rem; }
		.running .card { max-width: 680px; margin: 0 auto; }
	</style>
	<div class="running">
		<div class="card">
			<img src="data:image/svg+xml;base64,PCEtLSBHZW5lcmF0ZWQgYnkgSWNvTW9vbi5pbyAtLT4KPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMjQiIGhlaWdodD0iMTAyNCIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCI+Cjx0aXRsZT48L3RpdGxlPgo8ZyBpZD0iaWNvbW9vbi1pZ25vcmUiPgo8L2c+CjxwYXRoIGZpbGw9IiNkZjAwMDAiIGQ9Ik05NDIuNDIxIDIzNC42MjRsODAuODExLTgwLjgxMS0xNTMuMDQ1LTE1My4wNDUtODAuODExIDgwLjgxMWMtNzkuOTU3LTUxLjYyNy0xNzUuMTQ3LTgxLjU3OS0yNzcuMzc2LTgxLjU3OS0yODIuNzUyIDAtNTEyIDIyOS4yNDgtNTEyIDUxMiAwIDEwMi4yMjkgMjkuOTUyIDE5Ny40MTkgODEuNTc5IDI3Ny4zNzZsLTgwLjgxMSA4MC44MTEgMTUzLjA0NSAxNTMuMDQ1IDgwLjgxMS04MC44MTFjNzkuOTU3IDUxLjYyNyAxNzUuMTQ3IDgxLjU3OSAyNzcuMzc2IDgxLjU3OSAyODIuNzUyIDAgNTEyLTIyOS4yNDggNTEyLTUxMiAwLTEwMi4yMjktMjkuOTUyLTE5Ny40MTktODEuNTc5LTI3Ny4zNzZ6TTE5NC45NDQgNTEyYzAtMTc1LjEwNCAxNDEuOTUyLTMxNy4wNTYgMzE3LjA1Ni0zMTcuMDU2IDQ4IDAgOTMuNDgzIDEwLjY2NyAxMzQuMjI5IDI5Ljc4MWwtNDIxLjU0NyA0MjEuNTQ3Yy0xOS4wNzItNDAuNzg5LTI5LjczOS04Ni4yNzItMjkuNzM5LTEzNC4yNzJ6TTUxMiA4MjkuMDU2Yy00OCAwLTkzLjQ4My0xMC42NjctMTM0LjIyOS0yOS43ODFsNDIxLjU0Ny00MjEuNTQ3YzE5LjA3MiA0MC43ODkgMjkuNzgxIDg2LjI3MiAyOS43ODEgMTM0LjIyOS0wLjA0MyAxNzUuMTQ3LTE0MS45OTUgMzE3LjA5OS0zMTcuMDk5IDMxNy4wOTl6Ii8+PC9zdmc+Cg=="  height="100" alt="status">
			<h1><font color="color:red"><%:The homebox service is not running.%></font></h1>
			<p><%:Please enable the Homebox service%></p>
		</div>
	</div>
<% end %>
</div>
<%+cbi/valuefooter%>
