// SPDX-License-Identifier: GPL-2.0-or-later OR MIT

#include "ar9331.dtsi"

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/leds/common.h>

/ {
    model = "Dragino LPS8N";
    compatible = "dragino,lps8n", "qca,ar9331";

    aliases {
        label-mac-device = &wmac;
        spi1 = &spidev_gpio;
    };

    leds {
        compatible = "gpio-leds";

        wlan {
            function = LED_FUNCTION_WLAN;
            color = <LED_COLOR_ID_RED>;
            gpios = <&gpio 0 GPIO_ACTIVE_LOW>;
            linux,default-trigger = "phy0tpt";
        };

        wan {
            label = "dragino2:red:wan";
            gpios = <&gpio 17 GPIO_ACTIVE_LOW>;
        };

        lan {
            label = "dragino2:red:lan";
            gpios = <&gpio 13 GPIO_ACTIVE_LOW>;
        };

        system {
            label = "dragino2:red:system";
            gpios = <&gpio 28 GPIO_ACTIVE_LOW>;
        };
    };

    keys {
        compatible = "gpio-keys";

        wps {
            label = "wps";
            linux,code = <KEY_WPS_BUTTON>;
            gpios = <&gpio 11 GPIO_ACTIVE_LOW>;
            debounce-interval = <60>;
        };

        reset {
            label = "reset";
            linux,code = <KEY_RESTART>;
            gpios = <&gpio 12 GPIO_ACTIVE_LOW>;
            debounce-interval = <60>;
        };
    };

    /* Software SPI for SX1302 + SX1250 (GPIO18 MOSI, GPIO20 MISO, GPIO24 SCK, GPIO19 CSN)*/
    spidev_gpio: spi-gpio {
        compatible = "spi-gpio";
        #address-cells = <1>;
        #size-cells = <0>;
        status = "okay";

        sck-gpios = <&gpio 24 GPIO_ACTIVE_HIGH>;
        mosi-gpios = <&gpio 18 GPIO_ACTIVE_HIGH>;
        miso-gpios = <&gpio 20 GPIO_ACTIVE_HIGH>;
        cs-gpios = <&gpio 19 GPIO_ACTIVE_LOW>;

        spidev@0 {
            compatible = "spidev";
            status = "okay";
            reg = <0>;
            spi-max-frequency = <2000000>;
        };
    };

    /* Bit-banged I2C on GPIO7 (SDA) and GPIO8 (SCL) */
    i2c_gpio: i2c-gpio {
        compatible = "i2c-gpio";
        #address-cells = <1>;
        #size-cells = <0>;
        status = "okay";

        sda-gpios = <&gpio 7 GPIO_ACTIVE_HIGH>;
        scl-gpios = <&gpio 8 GPIO_ACTIVE_HIGH>;
        i2c-gpio,delay-us = <5>;
    };
};

&ref {
    clock-frequency = <40000000>;
};

&gpio {
    sx1302_reset {
        gpio-hog;
        gpios = <23 GPIO_ACTIVE_LOW>;
        output-high; /* deassert reset by default */
        line-name = "sx1302_reset";
    };
};

&usb {
    dr_mode = "host";
    status = "okay";
};

&usb_phy {
    status = "okay";
};

&spi {
    status = "okay";

    flash@0 {
        compatible = "jedec,spi-nor";
        spi-max-frequency = <50000000>;
        reg = <0>;

        partitions {
            compatible = "fixed-partitions";
            #address-cells = <1>;
            #size-cells = <1>;

            uboot: partition@0 {
                label = "u-boot";
                reg = <0x000000 0x040000>; // 256k
                read-only;
            };

            firmware: partition@40000 {
                compatible = "denx,uimage";
                label = "firmware";
                reg = <0x040000 0xFA0000>; // 16000k
            };

            config: partition@fe0000 {
                label = "config";
                reg = <0xFE0000 0x010000>; // 64k
            };

            art: partition@ff0000 {
                label = "art";
                reg = <0xFF0000 0x010000>; // 64k
                read-only;

                nvmem-layout {
                    compatible = "fixed-layout";
                    #address-cells = <1>;
                    #size-cells = <1>;

                    macaddr_art_0: macaddr@0 {
                        reg = <0x0 0x6>;
                    };

                    macaddr_art_6: macaddr@6 {
                        reg = <0x6 0x6>;
                    };

                    cal_art_1000: calibration@1000 {
                        reg = <0x1000 0x440>;
                    };
                };
            };
        };
    };
};

&mdio0 {
    status = "okay";
};

&eth0 {
    status = "okay";

    nvmem-cells = <&macaddr_art_0>;
    nvmem-cell-names = "mac-address";

    gmac-config {
        device = <&gmac>;
        switch-phy-addr-swap = <1>;
        switch-phy-swap = <1>;
    };
};

&eth1 {
    status = "okay";

    nvmem-cells = <&macaddr_art_6>;
    nvmem-cell-names = "mac-address";
};

&wmac {
    status = "okay";

    nvmem-cells = <&macaddr_art_6>, <&cal_art_1000>;
    nvmem-cell-names = "mac-address", "calibration";
};


